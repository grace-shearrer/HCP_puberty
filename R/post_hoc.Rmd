---
title: "HCP_puberty_ph"
output:
  html_document: default
  pdf_document: default
---

# Visualizations in wb_view
# Further analysis in jupyter
```{r, message=FALSE, warning=FALSE}
library(plyr)
library(psych)
library(ggplot2)
library(Hmisc)
library(stats)
library(lm.beta)
library(lmtest)
library(ggpubr)
library(dotwhisker)
library(boot)
library(knitr)
library(kableExtra)
library(ggdag)
library(mosaic)
library(mets)
library(xtable)
library(stargazer)
library(yhat)
library(tidyverse)
library(broom)
library(lmSupport)
library(MuMIn)
library(phia)
library(nlme)
#devtools::install_github("malcolmbarrett/ggdag")
#devtools::install_github("kkholst/lava")  
#devtools::install_github("kkholst/mets")  
cbPalette <- c("#CC79A7", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00")
bwPalette<-c("#000000", "#999999", "CCCCCC","666666","333333")
```

## Loading datasets and combining
```{r, echo=FALSE, warning=FALSE,message=FALSE}
unres<-read.table("~/Google Drive/HCP_graph/1200/datasets/unrestricted_gshearrer_4_19_2018_11_31_37.csv", header=T, sep=",")
res<-read.table("~/Google Drive/HCP_graph/1200/datasets/RESTRICTED_gshearrer_4_19_2018_11_33_34.csv", header=T, sep=",")
interest<-read.table("~/Google Drive/HCP_graph/1200/5000perms/post_hoc/vars_of_interest.csv", sep=",", header=F)
glm<-read.table("~/Google Drive/HCP_graph/1200/5000perms/glm.txt", sep="\t", header=F)

names(glm)<-c("Subject", "group","BMI_C","AOM_C","int","race","age")
subs<-read.table("~/Google Drive/HCP_graph/1200/datasets/subjectIDs.txt", header=F, sep=" ")
names(subs)<-"Subject"
netmat<-read.table("~/Google Drive/HCP_graph/1200/datasets/3T_HCP1200_MSMAll_d15_ts2_nets/netmats1.txt", header=F, sep=" ")

summary(glm$group)

NM<-cbind(subs,netmat)

d0<-join(unres, res)

d1<-join(d0,glm)

d2<-d1[,colnames(d1)%in%interest$V1] 

d3<-join(d2,NM)

d4<-subset(d3, d3$group == 1)
summary(is.na(d4$V36))
d4<-d4[!is.na(d4$V36),]
#head(netmat)
dim(d4)
d4$BMI_C
```
The missing check is OK. Lines up with imaging data.


```{r}
summary(d4$Age_in_Yrs)
sd(d4$Age_in_Yrs)
summary(d4$Menstrual_AgeBegan)
sd(d4$Menstrual_AgeBegan)

d4$Race <- relevel(d4$Race, "White")

dem1<-lm(Menstrual_AgeBegan ~ Race, data=d4)
summary(dem1)
lm.beta(dem1)

dem2<-lm(BMI ~ Race, data=d4)
summary(dem2)
lm.beta(dem2)

dem3<-lm(Age_in_Yrs ~ Race, data=d4)
summary(dem3)
lm.beta(dem3)

```


Nice function to make a pretty table
```{r}
tablr<-function(Y,x,D){
  Q<-favstats(Y ~ x, data = D)
  Q.stat <- Q[, c("x", "n", "mean", "sd")] 
  colnames(Q.stat)<-c("test","n", "mean", "sd")
  a<-match.call()[2]
  return(Q.stat)
}
```


# Making a nice table
```{r, warning=FALSE, message=FALSE}
demo_vars<-c("Race","BMI","HbA1C","Menstrual_AgeBegan","Age_in_Yrs","group")
dems<-d4[demo_vars]
#dems<-na.omit(dems)
byRace<-apply(dems, MARGIN = 2, FUN = tablr, x=dems$Race, D=dems)
byGroup<-apply(dems, MARGIN = 2, FUN = tablr, x=dems$group, D=dems)
t1<-merge(byRace$BMI,byRace$HbA1C,by="test")
t2<-merge(t1,byRace$Menstrual_AgeBegan,by="test")
t3<-merge(t2, byRace$Age_in_Yrs, by="test")


s1<-merge(byGroup$BMI,byGroup$HbA1C,by="test")
s2<-merge(s1,byGroup$Menstrual_AgeBegan,by="test")
s3<-merge(s2, byGroup$Age_in_Yrs, by="test")


all<-rbind(t3,s3)
row.names(all)<-all$test
row.names(all)<-c("Native American", "Asian, Native Hawaiian, or Pacific Islander","Black or African American","More than one race","Unknown or chose not to report","White","Total")

drops <- c("test")
all<-all[ , !(names(all) %in% drops)]
```



# Make the nice table
```{r nice table}
kable(all, format = "html",  col.names = c("n","mean","SD",
                                           "n","mean","SD",
                                           "n","mean","SD",
                                           "n","mean","SD"),
      caption = "Table 1: Descriptive statistics by reported race",
      digits = c(0, 2, 2, 0, 2, 2,0, 2, 2,0, 2, 2), align = "ccrr") %>%
  kable_styling(full_width = FALSE, position = "left") %>%
  add_header_above(c(" " = 1,"BMI"= 3,"HbA1C"= 3,"Age of menses onset"=3,"Age at scan"=3))

```

# Summary of main findings
Earlier onset of puberty significantly related to heavier adult BMI.
```{r interaction graph}
int_graph<-ggplot(d4, aes(Menstrual_AgeBegan, BMI)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm,colour='black')+theme_classic()+scale_y_continuous(name="Body Mass Index (BMI)")+
  scale_x_continuous(name="Age of onset of menstration (years)")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))
int_graph
```

```{r, results="asis"}
m1<-lm( BMI ~  Menstrual_AgeBegan, data=d4)
summary(m1)
m2<-lm( BMI ~  Menstrual_AgeBegan+Age_in_Yrs, data=d4)
lrtest(m1,m2)
summary(m2)
m3<-lm( BMI ~  Menstrual_AgeBegan+Age_in_Yrs+Race, data=d4)
lrtest(m2,m3)
summary(m3)
lm.beta(m3)
effect.size(m3)
modelEffectSizes(m3)
confint(m3)
```

```{r cleaning up for table}
x<-as.data.frame(summary(m3)[4])
row.names(x)<-c("Intercept","Menstrual age began (yrs)","Age (yrs)", "Asian American, Native Hawaiian, Other Pacific Islander", "Black or African American", "More than one race","Unknown race or not reported", "White")
x
```

```{r table 2}
kable(x, format = "html",  
      caption = "Table 2: Relationship between BMI and Age of onset of menses",
      digits = c(2,2,2,2), align = "cccc", col.names = c("Estimate", "Standard Error","T value","P value")) %>%
  kable_styling()


```

## Summary
Age of menstration is significantly related to adult BMI. This relationship remains significant with the addition of age and race in the model. Both age and race improve the model fit.


```{r, eval=FALSE, echo=FALSE}
x<-(1:225)
B = matrix( x,nrow=15, ncol=15)
```

# Imaging data
```{r reading in data}
img<-read.table("~/Google Drive/HCP_graph/1200/5000perms/p_corrected.csv", sep=",", header=F)
row.names(img)<-c("<BMI",">BMI","<AoM",">AoM","<AoMxBMI",">AoMxBMI")
# head(img)
img_p<-1-img
# head(img_p)
bool<-img_p<0.05
img_p[img_p > 0.05] <- NA
```

# Significant positive BMI
5->7 == V67
5->10 == V70
9->11 == V131
10->13 == V148
14->12 == V207
```{r significant pos BMI}
matrix( as.matrix(img_p[1,1:225]),nrow=15, ncol=15)
```
```{r plotting positive BMI}
p1<-ggplot(d4, aes(BMI, V67)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm)+scale_y_continuous(name="5 and 7")+
  scale_x_continuous(name="BMI")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))

p2<-ggplot(d4, aes(BMI, V70)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm)+scale_y_continuous(name="5 and 10")+
  scale_x_continuous(name="BMI")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))

p3<-ggplot(d4, aes(BMI, V131)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm)+scale_y_continuous(name="9 and 11")+
  scale_x_continuous(name="BMI")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))

p4<-ggplot(d4, aes(BMI, V148)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm)+scale_y_continuous(name="10 and 13")+
  scale_x_continuous(name="BMI")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))

ggarrange(p1,p2,p3,p4 + rremove("x.text"), 
          labels = c("A", "B", "C","D"),
          ncol = 2, nrow = 2)
```

# Significant negative BMI
1->6 == V6
3->4 == V34
4->8 == V53
4->15 == V60
10->12 == V147
10->15 == V150
```{r significant negative BMI}
matrix( as.matrix(img_p[2,1:225]),nrow=15, ncol=15)
```

```{r plotting negative}
p1<-ggplot(d4, aes(BMI, V6)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm)+scale_y_continuous(name="1 and 6")+
  scale_x_continuous(name="BMI")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))

p2<-ggplot(d4, aes(BMI, V34)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm)+scale_y_continuous(name="3 and 4")+
  scale_x_continuous(name="BMI")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))

p3<-ggplot(d4, aes(BMI, V53)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm)+scale_y_continuous(name="4 and 8")+
  scale_x_continuous(name="BMI")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))

p4<-ggplot(d4, aes(BMI, V60)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm)+scale_y_continuous(name="4 and 15")+
  scale_x_continuous(name="BMI")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))

ggarrange(p1,p2,p3,p4 + rremove("x.text"), 
          labels = c("A", "B", "C","D"),
          ncol = 2, nrow = 2)
```

# Significant positive AoM
12->15 == V180

```{r significant positive}
matrix( as.matrix(img_p[3,1:225]),nrow=15, ncol=15)
```

```{r plotting significant positive AoM}
p1<-ggplot(d4, aes(Menstrual_AgeBegan, V180)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm)+scale_y_continuous(name="12 and 15")+
  scale_x_continuous(name="AoM")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))

p1
```

# Significant negative AoM
none
```{r significant negtive AoM}
matrix( as.matrix(img_p[4,1:225]),nrow=15, ncol=15)
```

# Tertiles
So we can visualize the interaction effect
```{r looking at tertiles}
describe(d4$Menstrual_AgeBegan)
hist(d4$Menstrual_AgeBegan)

quantile(d4$Menstrual_AgeBegan, prob = c(0.33, 0.66))

d4$AoM[d4$Menstrual_AgeBegan<12]<-"early"
d4$AoM[d4$Menstrual_AgeBegan>13]<-"late"

summary(as.factor(d4$AoM))

write.table(d4,"~/Google Drive/HCP_graph/1200/datasets/post_hoc.csv", sep=",", row.names = FALSE)
```
# Significant positive AoMxBMI
## 12 (visual cortex)->13 (somatosensory - mouth) == V178  
### IC 12
![IC12](https://github.com/grace-shearrer/HCP_puberty/blob/master/viz/IC12_gordon.png?raw=true)
![IC12_sub](https://github.com/grace-shearrer/HCP_puberty/blob/master/viz/IC12_gordon_sub.png?raw=true)

### IC 13
![IC13](https://github.com/grace-shearrer/HCP_puberty/blob/master/viz/IC13_gordon.png?raw=true)
![IC13_sub](https://github.com/grace-shearrer/HCP_puberty/blob/master/viz/IC12_gordon_sub.png?raw=true)

## 3 (visual) -> 6 (cingulo-opercular) == V36
### IC 3
![IC3](https://github.com/grace-shearrer/HCP_puberty/blob/master/viz/IC3_gordon.png?raw=true)
![IC3_sub](https://github.com/grace-shearrer/HCP_puberty/blob/master/viz/IC3_gordon_sub.png?raw=true)

### IC 6
![IC6](https://github.com/grace-shearrer/HCP_puberty/blob/master/viz/IC6_gordon.png?raw=true)
![IC6_sub](https://github.com/grace-shearrer/HCP_puberty/blob/master/viz/IC6_gordon_sub.png?raw=true)

```{r significant BMIxAoM positive}
matrix( as.matrix(img_p[5,1:225]),nrow=15, ncol=15)
```

```{r, plotting the interaction between BMI and AoM on connectivity}
n=50
p1<-ggplot(subset(d4, !is.na(d4$AoM)), aes(BMI, V36, group=AoM, color=AoM)) +
  geom_point(aes(shape=AoM), size=2) + 
  geom_smooth(method=lm, aes(linetype=AoM))+
  scale_y_continuous(name="Correlation between\n IC3 and IC6")+
  scale_x_continuous(name="BMI")+
  theme_classic()+ 
  scale_shape_manual(values = c(1, 2),
    breaks = c("early","late"),
    labels = c("Early onsent (<12y)", "Late onsent (>13y)"),
    guide = guide_legend(title.position = "top", title = "Age at onset of menses", size=20))+
  scale_color_manual(values = c("black", "#333333"),
    breaks = c("early","late"),
    labels = c("Early onsent (<12y)", "Late onsent (>13y)"),
    guide = guide_legend(title.position = "top", title = "Age at onset of menses", size=20))+
  scale_linetype_manual(values=c("solid","dashed"),
                        breaks = c("early","late"),
                        labels = c("Early onsent (<12y)", "Late onsent (>13y)"),
                        guide = guide_legend(title.position = "top", title = "Age at onset of menses", size=20))+
  theme(axis.title.x = element_text(size=20), axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text(size=20), axis.text.y  = element_text(size=20))+ 
  theme(legend.text = element_text(size=20))+ 
  theme(legend.title = element_text(size=20, face="bold"))

p2<-ggplot(subset(d4, !is.na(d4$AoM)), aes(BMI, V178, group=AoM, color=AoM)) +
  geom_point(aes(shape=AoM), size=2) + 
  geom_smooth(method=lm, aes(linetype=AoM))+
  scale_y_continuous(name="Correlation between\n IC12 and IC13")+
  scale_x_continuous(name="BMI")+
  theme_classic()+ 
  scale_shape_manual(values = c(1, 2),
    breaks = c("early","late"),
    labels = c("Early onsent (<12y)", "Late onsent (>13y)"),
    guide = guide_legend(title.position = "top", title = "Age at onset of menses", size=20))+
  scale_color_manual(values = c("black", "#333333"),
    breaks = c("early","late"),
    labels = c("Early onsent (<12y)", "Late onsent (>13y)"),
    guide = guide_legend(title.position = "top", title = "Age at onset of menses", size=20))+
  scale_linetype_manual(values=c("solid","dashed"),
                        breaks = c("early","late"),
                        labels = c("Early onsent (<12y)", "Late onsent (>13y)"),
                        guide = guide_legend(title.position = "top", title = "Age at onset of menses", size=20))+
  theme(axis.title.x = element_text(size=20), axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text(size=20), axis.text.y  = element_text(size=20))+ 
  theme(legend.text = element_text(size=20))+ 
  theme(legend.title = element_text(size=20, face="bold"))
  

interaction_plot<- ggarrange(p1,p2 ,
                             labels = c("A", "B"),
                             ncol = 2, nrow = 1)
interaction_plot
```

# Significant negative AoMxBMI
2 (DMN) ->3 (visual) == V18
### IC 2
![IC2](https://github.com/grace-shearrer/HCP_puberty/blob/master/viz/IC2_gordon.png?raw=true)
![IC2_sub](https://github.com/grace-shearrer/HCP_puberty/blob/master/viz/IC2_gordon_sub.png?raw=true)

### IC 3
![IC3](https://github.com/grace-shearrer/HCP_puberty/blob/master/viz/IC3_gordon.png?raw=true)
![IC3_sub](https://github.com/grace-shearrer/HCP_puberty/blob/master/viz/IC3_gordon_sub.png?raw=true)


```{r, negative relationship between BMI and AoM on connectivity}
matrix( as.matrix(img_p[6,1:225]),nrow=15, ncol=15)
```
```{r plotting the negative AoMxBMI interaction}
p3<-ggplot(subset(d4, !is.na(d4$AoM)), aes(BMI, V18, group=AoM, color=AoM)) +
  geom_point(aes(shape=AoM), size=2) + 
  geom_smooth(method=lm, aes(linetype=AoM))+
  scale_y_continuous(name="Correlation between\n IC2 and IC3")+
  scale_x_continuous(name="BMI")+
  theme_classic()+ 
  scale_shape_manual(values = c(1, 2),
    breaks = c("early","late"),
    labels = c("Early onsent (<12y)", "Late onsent (>13y)"),
    guide = guide_legend(title.position = "top", title = "Age at onset of menses", size=20))+
  scale_color_manual(values = c("black", "#333333"),
    breaks = c("early","late"),
    labels = c("Early onsent (<12y)", "Late onsent (>13y)"),
    guide = guide_legend(title.position = "top", title = "Age at onset of menses", size=20))+
  scale_linetype_manual(values=c("solid","dashed"),
                        breaks = c("early","late"),
                        labels = c("Early onsent (<12y)", "Late onsent (>13y)"),
                        guide = guide_legend(title.position = "top", title = "Age at onset of menses", size=20))+
  theme(axis.title.x = element_text(size=20), axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text(size=20), axis.text.y  = element_text(size=20))+ 
  theme(legend.text = element_text(size=20))+ 
  theme(legend.title = element_text(size=20, face="bold"))

p3
```

# Post hoc analysis of HCP data for puberty paper
## Checking the fertility data
```{r fertility}
summary(as.factor(d4$Menstrual_UsingBirthControl))
# yes = 1
onBC<-subset(d4, d4$Menstrual_UsingBirthControl == "1")
summary(as.factor(onBC$Menstrual_UsingBirthControl))
summary(as.factor(onBC$Menstrual_BirthControlCode))
# 1=OC's for contraception, 2=OC's primarily for menstrual regulation, 3=estradiol for menstrual regulation, 4=progesterone for menstrual regulation, 5=fertility therapy, 6=other, 7=unknown  (Asked of female participants only) 
```
## Checking SES
```{r creating SES categories}
# SSAGA_Employ SSAGA_Income SSAGA_Educ SSAGA_InSchool SSAGA_Rlshp
## not working = 0, part-time employment = 1; full-time employment = 2
summary(as.factor(d4$SSAGA_Employ))
## Total household income: <$10,000 = 1,10K-19,999 = 2, 20K-29,999 = 3,30K-39,999 = 4, 40K-49,999 = 5, 50K-74,999 = 6, 75K-99,999 = 7, >=100,000 = 8
## Low income == 1-2
summary(as.factor(d4$SSAGA_Income))
## Years of education completed: <11 = 11; 12; 13; 14; 15; 16; 17+ = 17
summary(as.factor(d4$SSAGA_Educ))
## Is respondent still in school for degree course? no = 0; yes = 1
summary(as.factor(d4$SSAGA_InSchool))
## Is respondent married or in live-in relationship? no = 0; yes = 1
summary(as.factor(d4$SSAGA_Rlshp))

low_income_single<-subset(d4 , d4$SSAGA_InSchool == 0 & d4$SSAGA_Rlshp == 0 & d4$SSAGA_Income %in% c('1', '2'))
low_income_married<-subset(d4 , d4$SSAGA_InSchool == 0 & d4$SSAGA_Rlshp == 1 & d4$SSAGA_Income %in% c('1', '2','3'))
low<-rbind(low_income_married, low_income_single)

d4$SES[d4$SSAGA_InSchool == 0 & d4$SSAGA_Rlshp == 0 & d4$SSAGA_Income %in% c('1', '2')]<-"low_single"
d4$SES[d4$SSAGA_InSchool == 0 & d4$SSAGA_Rlshp == 1 & d4$SSAGA_Income %in% c('1', '2','3')]<-"low_married"
d4$SES[d4$SSAGA_InSchool == 0 & d4$SSAGA_Rlshp == 0 & d4$SSAGA_Income %in% c('3','4','5','6','7','8')]<-"norm_single"
d4$SES[d4$SSAGA_InSchool == 0 & d4$SSAGA_Rlshp == 1 & d4$SSAGA_Income %in% c('4','5','6','7','8')]<-"norm_married"

d4$SES[d4$SSAGA_InSchool == 1 & d4$SSAGA_Rlshp == 0 & d4$SSAGA_Income %in% c('1', '2')]<-"low_single_school"
d4$SES[d4$SSAGA_InSchool == 1 & d4$SSAGA_Rlshp == 1 & d4$SSAGA_Income %in% c('1', '2','3')]<-"low_married_school"
d4$SES[d4$SSAGA_InSchool == 1 & d4$SSAGA_Rlshp == 0 & d4$SSAGA_Income %in% c('3','4','5','6','7','8')]<-"norm_single_school"
d4$SES[d4$SSAGA_InSchool == 1 & d4$SSAGA_Rlshp == 1 & d4$SSAGA_Income %in% c('4','5','6','7','8')]<-"norm_married_school"

d4$SES_comp[d4$SES %in% c('low_single', 'low_married','low_single_school','low_married_school')]<-"low"
d4$SES_comp[d4$SES %in% c('norm_single', 'norm_married','norm_single_school','norm_married_school')]<-"norm"
```
## Defintition of low income
If single: THI < 20K
If married: THI <30K


```{r plotting effect of SES}
ggplot(subset(d4, d4$SES_comp != is.na(d4$SES_comp)), aes(Menstrual_AgeBegan, BMI, group=SES_comp, color=SES_comp)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm)+theme_classic()+scale_y_continuous(name="Body Mass Index (BMI)")+
  scale_x_continuous(name="Age of onset of menstration")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))
```
```{r binary logistic regression for SES}
d4$SES_comp <- factor(d4$SES_comp)
summary(d4$SES_comp)
mylogit <- glm(SES_comp ~ Menstrual_AgeBegan*BMI, data = subset(d4, d4$SES_comp != is.na(d4$SES_comp)), family = "binomial")
summary(mylogit)
```

## Nodes of interest 
sig 3->6 == V36
check 6 -> 3 == V78
12->13 == V192
check 13->12 == V178

## Control variables
Race
Ethnicity
Age_in_Yrs
```{r control variables}
ctrl1<-lm(BMI~Race+Ethnicity+Age_in_Yrs, data=d4)
p.adjust(coef(summary(ctrl1))[, 4], method="BH")
ctrl2<-lm(Menstrual_AgeBegan~Race+Ethnicity+Age_in_Yrs, data=d4)
p.adjust(coef(summary(ctrl2))[, 4], method="BH")

twoM <- rbind(tidy(ctrl1) %>% mutate(model = "Relationshio to BMI"), 
                tidy(ctrl2) %>% mutate(model = "Relationship to age at onset of menses")
                )

SI1<-dwplot(twoM, vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2)) +theme_classic()
SI1
```

Looks like I can drop ethnicity since it is not related to either BMI nor Puberty.

# False Discovery Correction 
Bonferroni
Cor #: 11
```{r bonferroni correction}
ad = 11
```


# Delay Discounting: Area Under the Curve for Discounting of $200 (DDisc_AUC_200)	Cognition	Self-regulation/Impulsivity (Delay Discounting)	DDisc_AUC_200
```{r Delay Discounting $200}
mDD1<-lm(DDisc_AUC_200~BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mDD1)
```

# Delay Discounting: Area Under the Curve for Discounting of $40,000 (DDisc_AUC_40K)	Cognition	Self-regulation/Impulsivity (Delay Discounting)	DDisc_AUC_40K
```{r}
mDD2<-lm(DDisc_AUC_40K~BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mDD2)#trend
p.adjust(coef(summary(mDD2))[, 4], method="BH", ad)
```


# NIH Toolbox Picture Sequence Memory Test: Age-Adjusted Scale Score
```{r NIH Toolbox Picture Sequence Memory}
mSM1<-lm(PicSeq_AgeAdj~BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mSM1)
```

# NIH Toolbox Dimensional Change Card Sort Test: Age-Adjusted Scale Score
```{r NIH Toolbox Dimensional Change Card Sort Test}
mCS1<-lm(CardSort_AgeAdj~BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mCS1)
```

# NIH Toolbox Flanker Inhibitory Control and Attention Test: Age-Adjusted Scale Score
```{r}
mFl1<-lm(Flanker_AgeAdj~BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mFl1)
```

# NIH Toolbox Cognition Fluid Composite: Age Adjusted Scale Score
```{r}
mCF1<-lm(CogFluidComp_AgeAdj~BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mCF1)
```

# NIH Toolbox Cognition Total Composite Score: Age Adjusted Scale Score
```{r}
mCCom1<-lm(CogTotalComp_AgeAdj~BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mCCom1)
```


# NIH Toolbox Cognition Crystallized Composite: Age Adjusted Scale Score
## About 
The Crystallized Cognition Composite score is derived by averaging the normalized scores of each of the Toolbox tests that are crystallized measures (Picture Vocabulary and Reading Tests), then deriving scale scores based on this new distribution. One can interpret the Crystallized Cognition Composite as a more global assessment of individual and group verbal reasoning. Higher scores indicate higher levels of functioning. Age-adjusted Scale Score: Participant score is normed using the age appropriate band of Toolbox Norming Sample (bands of ages 18-29, or 30-35), where a score of 100 indicates performance that was at the national average and a score of 115 or 85, indicates performance 1 SD above or below the national average for participants age band.
```{r}
mCCr1<-lm(CogCrystalComp_AgeAdj~BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mCCr1) #SIGNIFICANT
### it appears that race only improves the model for Asian therefore we will test this without the asian population which is low (36)
p.adjust(coef(summary(mCCr1))[, 4], method="BH", ad)
```
```{r plot of the crystalized cognition}
ggplot(subset(d4, !is.na(AoM)), aes(BMI, CogCrystalComp_AgeAdj, color=AoM, group=AoM)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm)+scale_y_continuous(name="crystal cognition")+
  scale_x_continuous(name="BMI")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))
```
# HbA1c
```{r}
mHb1<-lm(HbA1C~BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mHb1)
```

# NIH Toolbox 2-minute Walk Endurance Test : Age-Adjusted Scale Score	Motor	Endurance (2 minute walk test)	Endurance_AgeAdj
```{r NIH Toolbox 2-minute Walk Endurance Test}
mEn1<-lm(Endurance_AgeAdj~BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mEn1)
```

# NIH Toolbox Grip Strength Test: Age-Adjusted-Adjusted Scale Score	Motor	Strength (Grip Strength Dynamometry)	Strength_AgeAdj
```{r NIH Toolbox Grip Strength Test}
mSt1<-lm(Strength_AgeAdj ~ BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mSt1)
```

# NIH Toolbox Perceived Stress Survey: Unadjusted Scale Score	Emotion	Stress and Self Efficacy (Perceived Stress, Self-Efficacy)	PercStress_Unadj
```{r}
mStress1<-lm(PercStress_Unadj~BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mStress1)
```

# Taste_AgeAdj
```{r}
mTaste1<-lm(Taste_AgeAdj~BMI*Menstrual_AgeBegan+Race+Age_in_Yrs, data = d4)
summary(mTaste1)
```

## Heritability
Self-reported zygosity. Until the S1200 release this was the \Zygosity\" measure. The small number of subjects who do not have a value for this measure (blank) self reported as twins but did not self report their twin zygosity."  
Twin zygosity verified by genotyping. Requires both subjects in a twin pair to have HasGT=TRUE to have a value (if genotyping is not available for either of a twin pair, no values are given for ZygosityGT).  Non-twin subjects also do not have a value for ZygosityGT.  Note that some subjects self-reported as dizygotic twins (ZygositySR='NotMZ') but genotyping established that they were monozygotic twins (thence ZygosityGT='MZ' for those subjects).  ZygosityGT should be given precedence over ZygositySR.

## Nodes of interest 
sig 3->6 == V36
check 6 -> 3 == V78
12->13 == V192
check 13->12 == V178
```{r}
twins<-subset(d4 , d4$ZygosityGT %in% c('DZ', 'MZ'))
myvars<-c("Family_ID","Subject","Menstrual_AgeBegan","BMI","ZygosityGT","Age_in_Yrs","Race","Gender","V36","V78","V178","V192")
d5<-twins[myvars]
d5$ZygosityGT<-factor(d5$ZygosityGT)
d5$Race<-factor(d5$Race)
d6 <- fast.reshape(d5, id="Family_ID",varying=c("BMI","Menstrual_AgeBegan","Subject","V36","V78","V178","V192"))
d6<-na.omit(d6)
head(d6)
```

```{r}
library("cowplot")  
scatterdens <- function(x) {
  sp <- ggplot(x,aes_string(colnames(x)[1], colnames(x)[2])) + theme_minimal() + geom_point(alpha=0.3) + geom_density_2d()
  xdens <- ggplot(x, aes_string(colnames(x)[1],fill=1)) + theme_minimal() +  geom_density(alpha=.5)+ theme(axis.text.x = element_blank(), legend.position =  "none"  ) + labs(x=NULL) 
  ydens <- ggplot(x, aes_string(colnames(x)[2],fill=1)) +  theme_minimal() +  geom_density(alpha=.5) +    theme(axis.text.y = element_blank(),  axis.text.x = element_text(angle=90, vjust=0), legend.position =  "none"  ) +  labs(x=NULL) + coord_flip()   
  g <- plot_grid(xdens,NULL,sp,ydens, ncol=2,nrow=2,                                                                         rel_widths=c(4,1.4),rel_heights=c(1.4,4))   
  return(g)  
}
```

```{r}
mz_bmi <- log(subset(d6, ZygosityGT ==  "MZ"  )[,c("BMI1","BMI2")])  
p_bmi_mz<-scatterdens(mz_bmi)
mz_aom<-subset(d6, ZygosityGT ==  "MZ"  )[,c("Menstrual_AgeBegan1","Menstrual_AgeBegan2")]
p_aom_mz<-scatterdens(mz_aom)

mz_V178<-subset(d6, ZygosityGT ==  "MZ"  )[,c("V1781","V1782")]
p_V178_mz<-scatterdens(mz_V178)

mz_V36<-subset(d6, ZygosityGT ==  "MZ"  )[,c("V361","V362")]
p_V36_mz<-scatterdens(mz_V36)



dz_bmi <- log(subset(d6, ZygosityGT ==  "DZ"  )[,c(  "BMI1"  ,  "BMI2"  )]) 
p_bmi_dz<-scatterdens(dz_bmi)
dz_aom<-subset(d6, ZygosityGT ==  "DZ"  )[,c("Menstrual_AgeBegan1","Menstrual_AgeBegan2")]
p_aom_dz<-scatterdens(dz_aom)

dz_V178<-subset(d6, ZygosityGT ==  "DZ"  )[,c("V1781","V1782")]
p_V178_dz<-scatterdens(dz_V178)

dz_V36<-subset(d6, ZygosityGT ==  "DZ"  )[,c("V361","V362")]
p_V36_dz<-scatterdens(dz_V36)

pBMI<-ggarrange(p_bmi_mz,p_bmi_dz + rremove("x.text"), 
          labels = c("A", "B"),
          ncol = 2, nrow = 1)

pAoM<-ggarrange(p_aom_mz,p_aom_dz + rremove("x.text"), 
          labels = c("A", "B"),
          ncol = 2, nrow = 1)

pV178<-ggarrange(p_V178_mz,p_V178_dz + rremove("x.text"), 
          labels = c("A", "B"),
          ncol = 2, nrow = 1)

pV36<-ggarrange(p_V36_mz,p_V36_dz + rremove("x.text"), 
          labels = c("A", "B"),
          ncol = 2, nrow = 1)

```

```{r}
cor.test(mz_bmi[,1],mz_bmi[,2], method=  "spearman"  )  
cor.test(dz_bmi[,1],dz_bmi[,2], method=  "spearman"  )  

cor.test(mz_aom[,1],mz_aom[,2], method=  "spearman"  )  
cor.test(dz_aom[,1],dz_aom[,2], method=  "spearman"  )  
```

## About the results
Heritability is formally defined as the proportion of phenotypic variation (VP) that is due to variation in genetic values (VG).  
### Broad-sense heritability  
Defined as H2 = VG/VP, captures the *proportion of phenotypic variation due to genetic values that may include effects due to dominance and epistasis*.
 * dominance - possible allelic interactions within loci  
 * epistasis- between loci  

### Narrow-sense heritability
h2 = VA/VP, refers to the proportion of phenotypic variation that is due to additive genetic values (VA)

*The phenotypic variance (VP)* in a population is influenced by genetic variance (VG) and environmental sources (VE)

VP = VG + VE
so then narrow sense is also defined as:  

*h2 = EA/(VG+VE)*

The total amount of genetic variance can be divided into several groups, including additive variance (VA), dominance variance (VD), and epistatic variance (VI).
VG = VA + VD + VI
so then narrow sense is also:

*h2 = VA/(VA+VD+VI+VE)*

### variance components
* additive genetic (A)  
* common shared family environment (C)  
* non-shared environmental (E) 
* genetic dominance effects (D) 
```{r}
dd<-na.omit(d5)
dd$ZygosityGT <- factor(dd$ZygosityGT)
dd$Race<- factor(dd$Race)
l0.0<-lm(BMI~Age_in_Yrs+Race+Menstrual_AgeBegan, data = d4)
summary(l0.0)
l0 <- twinlm(BMI ~ 1+Age_in_Yrs+Race+Menstrual_AgeBegan, data=dd,  DZ= "DZ"  , zyg=  "ZygosityGT"  , id="Family_ID", type="aced", missing = T)  
summary(l0)

# AIC
AIC(l0.0)
AICc(l0,l0.0)
```
AIC
l0.0  3157.73
l0    1363.039 

AICc
     df     AICc
l0   11 1365.239
l0.0  9 3158.090
```{r}
bmi_acde<-summary(l0)$acde

bmi_acde %>%
  kable(digits = c(2,2,2)) %>%
  kable_styling( position = "left") %>%
  add_header_above(c(" "= 1, " " = 1, "Confidence Interval" = 2))
```



```{r}
l1.0<-lm(Menstrual_AgeBegan ~ Age_in_Yrs+Race, data =d4)
summary(l1.0)
l1 <- twinlm(Menstrual_AgeBegan ~ 1+Age_in_Yrs+Race, data=dd,  DZ= "DZ"  , zyg=  "ZygosityGT"  , id="Family_ID", type="aced", missing = T)  
summary(l1)

# AIC
AIC(l1.0)
AICc(l1,l1.0)
```
AIC 
l1  818.5318 
l1.0 1915.629

     df      AICc
l1   10  820.3499
l1.0  8 1915.9164

```{r}
aom_acde<-summary(l1)$acde
aom_acde %>%
  kable(digits = c(2,2,2)) %>%
  kable_styling( position = "left") %>%
  add_header_above(c(" "= 1, " " = 1, "Confidence Interval" = 2))
```


```{r}
l2.0<-lm(V178 ~ 1+BMI*Menstrual_AgeBegan+Age_in_Yrs+Race, data=d4)
summary(l2.0)
l2 <- twinlm(V178 ~ 1+BMI*Menstrual_AgeBegan+Age_in_Yrs+Race, data=d5,
DZ= "DZ"  , zyg=  "ZygosityGT"  , id="Family_ID", type="aced", missing = T)  
summary(l2)
# AIC
AIC(l2.0)
AICc(l2,l2.0)


2972.483-1309.755
```
##### AIC
AIC basic principles  
So to summarize, the basic principles that guide the use of the AIC are:  

* Lower indicates a more parsimonious model, relative to a model fit with a higher AIC.
* It is a relative measure of model parsimony, so it only has meaning if we compare the AIC for alternate hypotheses (= different models of the data).
* We can compare non-nested models. For instance, we could compare a linear to a non-linear model.
* The comparisons are only valid for models that are fit to the same response data (ie values of y).
* Model selection conducted with the AIC will choose the same model as leave-one-out cross validation (where we leave out one data point and fit the model, then evaluate its fit to that point) for large sample sizes.
* You shouldn’t compare too many models with the AIC. You will run into the same problems with multiple model comparison as you would with p-values, in that you might by chance find a model with the lowest AIC, that isn’t truly the most appropriate model.
* When using the AIC you might end up with multiple models that perform similarly to each other. So you have similar evidence weights for different alternate hypotheses. In the example above m3 is actually about as good as m1.
* You should correct for small sample sizes if you use the AIC with small sample sizes, by using the AICc statistic.

Example:
whose AIC values are 100, 102, and 110. Then the second model is exp((100−102)/2) = 0.368 times as probable as the first model to minimize the information loss. Similarly, the third model is exp((100−110)/2) = 0.007 times as probable as the first model to minimize the information loss.  

Plain AIC  
BMI:Menstrual_AgeBegan                    0.05400 AIC: 2971.953 
V178~BMI:Menstrual_AgeBegan               0.04817 AIC: 1306.67 <- lower so probably better

     df     AICc
l2   13 1309.755
l2.0 11 2972.483

l2 is a better fit
```{r}
V178_acde<-summary(l2)$acde
V178_acde %>%
  kable(digits = c(2,2,2)) %>%
  kable_styling( position = "left") %>%
  add_header_above(c(" "= 1, " " = 1, "Confidence Interval" = 2))
```



```{r}
l3.0<-lm(V36 ~ BMI*Menstrual_AgeBegan+Age_in_Yrs+Race, data=d4)
summary(l3.0)
l3 <- twinlm(V36 ~ 1+BMI*Menstrual_AgeBegan+Age_in_Yrs+Race, data=d5,
DZ= "DZ"  , zyg=  "ZygosityGT"  , id="Family_ID", type="aced", missing = T)  
summary(l3)
# AIC
AIC(l3.0)
AICc(l3,l3.0)

2676.394-1186.078
```
l3.0 2675.864
l3   1182.993 

     df     AICc
l3   13 1186.078
l3.0 11 2676.394

```{r}
V36_acde<-summary(l3)$acde

V36_acde %>%
  kable(digits = c(2,2,2)) %>%
  kable_styling( position = "left") %>%
  add_header_above(c(" "= 1, " " = 1, "Confidence Interval" = 2))

```



```{r}
x0<-summary(l0)
x1<-summary(l1)
x2<-summary(l2)
x3<-summary(l3)
y0<-as.data.frame(x0[9])
y1<-as.data.frame(x1[9])
y2<-as.data.frame(x2[9])
y3<-as.data.frame(x3[9])

y0$fac<-row.names(y0)
y1$fac<-row.names(y1)
y2$fac<-row.names(y2)
y3$fac<-row.names(y3)
```


```{r}
pd <- position_dodge(0.1) 
n0= 3

plt0<-ggplot(y0, aes(x=fac, y=acde.Estimate, color=fac)) + 
  ggtitle("BMI") + 
  geom_point(position=position_dodge(), stat="identity",size=n0) +
  geom_errorbar(aes(ymin=acde.2.5., ymax=acde.97.5.),
                size=1,    
                width=.5,
                position=position_dodge(.9))+
  geom_hline(aes(yintercept = 0),  color = "grey")+
  scale_color_manual(values = c("#000000", "#999999", "#CCCCCC",  "#666666"))+
  theme_classic()+
  scale_x_discrete(name="Genetic component")+
  scale_y_continuous(name="Estimate")+
  theme(axis.title.x = element_text(size=20), axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text(size=20), axis.text.y  = element_text(size=20))+ 
  theme(legend.text = element_text(size=20))+ 
  theme(legend.title = element_text(size=20, face="bold"))+
  theme(legend.position="none")
  

plt1<-ggplot(y1, aes(x=fac, y=acde.Estimate, color=fac)) + 
  ggtitle("Age at onset of menses") + 
  geom_point(position=position_dodge(), stat="identity",size=n0) +
  geom_errorbar(aes(ymin=acde.2.5., ymax=acde.97.5.),
                size=1,    
                width=.5,
                position=position_dodge(.9))+
  geom_hline(aes(yintercept = 0),  color = "grey")+
  scale_color_manual(values = c("#000000", "#999999", "#CCCCCC",  "#666666"))+
  theme_classic()+
  scale_x_discrete(name="Genetic component")+
  scale_y_continuous(name="Estimate")+
  theme(axis.title.x = element_text(size=20), axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text(size=20), axis.text.y  = element_text(size=20))+ 
  theme(legend.text = element_text(size=20))+ 
  theme(legend.title = element_text(size=20, face="bold"))+
  theme(legend.position="none")
  

plt2<-ggplot(y2, aes(x=fac, y=acde.Estimate, color=fac)) + 
  ggtitle("Correlation between IC12 and IC13") + 
  theme(plot.title = element_text(size = 20, face = "bold"))+
  geom_point(position=position_dodge(), stat="identity",size=n0) +
  geom_errorbar(aes(ymin=acde.2.5., ymax=acde.97.5.),
                size=1,    
                width=.5,
                position=position_dodge(.9))+
  geom_hline(aes(yintercept = 0),  color = "grey")+
  scale_color_manual(values = c("#000000", "#999999", "#CCCCCC",  "#666666"))+
  theme_classic()+
  scale_x_discrete(name="Genetic component")+
  scale_y_continuous(name="Estimate")+
  theme(axis.title.x = element_text(size=20), axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text(size=20), axis.text.y  = element_text(size=20))+ 
  theme(legend.text = element_text(size=20))+ 
  theme(legend.title = element_text(size=20, face="bold"))+
  theme(legend.position="none")

plt3<-ggplot(y3, aes(x=fac, y=acde.Estimate, color=fac)) + 
  ggtitle("Correlation between IC3 and IC6") + 
  theme(plot.title = element_text(size = 20, face = "bold"))+
  geom_point(position=position_dodge(), stat="identity",size=n0) +
  geom_errorbar(aes(ymin=acde.2.5., ymax=acde.97.5.),
                size=1,    
                width=.5,
                position=position_dodge(.9))+
  geom_hline(aes(yintercept = 0),  color = "grey")+
  scale_color_manual(values = c("#000000", "#999999", "#CCCCCC",  "#666666"))+
  theme_classic()+
  scale_x_discrete(name="Genetic component")+
  scale_y_continuous(name="Estimate")+
  theme(axis.title.x = element_text(size=20), axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text(size=20), axis.text.y  = element_text(size=20))+ 
  theme(legend.text = element_text(size=20))+ 
  theme(legend.title = element_text(size=20, face="bold"))+
  theme(legend.position="none")


acde<-ggarrange(plt0,plt1,plt2,plt3 + rremove("x.text"), 
          labels = c("A", "B","C","D"),
          ncol = 2, nrow = 2)
acde
```
## Summary

It appears that the genetic contribution in this sample to BMI and Age of onset of menses is minimal and predomiently through the enviroment. However, we see a large effect of both genetic domience and enviroment on connectivity between 12 and 13. Much more modest differences in the 3 and 6 connectivity with the enviroment.


## Response to reviewers
```{r}
motion<-read.table("~/Google Drive/HCP_graph/1200/datasets/HCP1200-Motion-Summaries.csv", header=T, sep=",")
head(motion)

d4m<-join(d4,motion)
```

```{r}
motion_graph<-ggplot(d4m, aes(BMI, motion)) +
  geom_point(shape=1) + 
  geom_smooth(method=lm,colour='black')+theme_classic()+scale_y_continuous(name="Frame to frame head motion summary")+
  scale_x_continuous(name="Body mass index (BMI)")+
  theme(axis.title.x = element_text( size=20),axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text( size=20),axis.text.y  = element_text(size=20))
motion_graph
```
```{r}
mm1<-lm( BMI ~  motion, data=d4m)
summary(mm1)
mm2<-lm( BMI ~  motion+Age_in_Yrs, data=d4m)
lrtest(mm1,mm2)
summary(mm2) #age and motion related to BMI
mm3<-lm( BMI ~  motion+Age_in_Yrs+Race, data=d4m)
lrtest(mm2,mm3)
summary(mm3)
mm4<-lm( BMI ~  motion+Menstrual_AgeBegan+Age_in_Yrs+Race, data=d4m)
lrtest(mm3,mm4)
summary(mm4) #menses is still significant even with motion parameters
summary(m3)

lm.beta(mm4)
effect.size(mm4)
modelEffectSizes(mm4)
confint(mm4)
```
### Heritability with motion correction
```{r}
twins<-subset(d4m , d4$ZygosityGT %in% c('DZ', 'MZ'))
myvars<-c("Family_ID","Subject","Menstrual_AgeBegan","BMI","ZygosityGT","Age_in_Yrs","Race","Gender","V36","V78","V178","V192", "motion")
d5m<-twins[myvars]
d5m$ZygosityGT<-factor(d5m$ZygosityGT)
d5m$Race<-factor(d5m$Race)
d6m <- fast.reshape(d5m, id="Family_ID",varying=c("BMI","Menstrual_AgeBegan","Subject","V36","V78","V178","V192", "motion"))
d6m<-na.omit(d6m)
```


```{r}
ddm<-na.omit(d5m)
ddm<-subset(ddm, ddm$ZygosityGT != " ")
ddm$ZygosityGT <- factor(ddm$ZygosityGT)
ddm<-na.omit(ddm)
ddm$Race<- factor(ddm$Race)
ddm$ZygosityGT <- factor(ddm$ZygosityGT)

l0.0m<-lm(BMI~Age_in_Yrs+Race+Menstrual_AgeBegan+motion, data = d4m)
summary(l0.0m)
l0m <- twinlm(BMI ~ 1+Age_in_Yrs+Race+Menstrual_AgeBegan+motion, data=ddm,  DZ= "DZ"  , zyg=  "ZygosityGT"  , id="Family_ID", type="aced", missing = T)  
summary(l0m)

# AIC
AIC(l0.0m)
AICc(l0m,l0.0m)
```
```{r}
l1.0m<-lm(BMI~Age_in_Yrs+Race+Menstrual_AgeBegan+motion, data = d4m)
summary(l1.0m)
l1m <- twinlm(Menstrual_AgeBegan ~ 1+Age_in_Yrs+Race+motion, data=ddm,  DZ= "DZ"  , zyg=  "ZygosityGT"  , id="Family_ID", type="aced", missing = T)  
summary(l1m)

# AIC
AIC(l1.0m)
AICc(l1m,l1.0m)
```
```{r}
l2.0m<-lm(V178 ~ BMI*Menstrual_AgeBegan+Age_in_Yrs+Race+motion, data = d4m)
summary(l2.0m)
l2m <- twinlm(V178 ~ 1+BMI*Menstrual_AgeBegan+Age_in_Yrs+Race+motion, data=ddm,  DZ= "DZ"  , zyg=  "ZygosityGT"  , id="Family_ID", type="aced", missing = T)  
summary(l2m)

# AIC
AIC(l2.0m)
AICc(l2m,l2.0m)
```
```{r}
l3.0m<-lm(V36 ~ BMI*Menstrual_AgeBegan+Age_in_Yrs+Race+motion, data = d4m)
summary(l2.0m)
l3m <- twinlm(V36 ~ 1+BMI*Menstrual_AgeBegan+Age_in_Yrs+Race+motion, data=ddm,  DZ= "DZ"  , zyg=  "ZygosityGT"  , id="Family_ID", type="aced", missing = T)  
summary(l3m)

# AIC
AIC(l3.0m)
AICc(l3m,l3.0m)
```
```{r}
ddmR<-subset(ddm, ddm$Race != "RaceAm. Indian/Alaskan Nat.")
ddmR$Race<-factor(ddmR$Race)
l4.0m<-lm(motion ~ Age_in_Yrs+Race*BMI, data = d4m)
summary(l4.0m)
ddmR<-na.omit(ddmR)
l4m <- twinlm(motion ~ 1+Age_in_Yrs+BMI:Race, data=ddmR,  DZ= "DZ"  , zyg=  "ZygosityGT"  , id="Family_ID", type="aced", missing = T)  
summary(l4m)

# AIC
AIC(l4.0m)
AICc(l4m,l4.0m)
```

```{r}
x0m<-summary(l0m)
x1m<-summary(l1m)
x2m<-summary(l2m)
x3m<-summary(l3m)
x4m<-summary(l4m)

y0m<-as.data.frame(x0m[9])
y1m<-as.data.frame(x1m[9])
y2m<-as.data.frame(x2m[9])
y3m<-as.data.frame(x3m[9])
y4m<-as.data.frame(x4m[9])

y0m$fac<-row.names(y0m)
y1m$fac<-row.names(y1m)
y2m$fac<-row.names(y2m)
y3m$fac<-row.names(y3m)
y4m$fac<-row.names(y4m)
```


```{r}
pd <- position_dodge(0.1) 
n0= 3

plt0m<-ggplot(y0m, aes(x=fac, y=acde.Estimate, color=fac)) + 
  ggtitle("BMI") + 
  geom_point(position=position_dodge(), stat="identity",size=n0) +
  geom_errorbar(aes(ymin=acde.2.5., ymax=acde.97.5.),
                size=1,    
                width=.5,
                position=position_dodge(.9))+
  geom_hline(aes(yintercept = 0),  color = "grey")+
  scale_color_manual(values = c("#000000", "#999999", "#CCCCCC",  "#666666"))+
  theme_classic()+
  scale_x_discrete(name="Genetic component")+
  scale_y_continuous(name="Estimate")+
  theme(axis.title.x = element_text(size=20), axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text(size=20), axis.text.y  = element_text(size=20))+ 
  theme(legend.text = element_text(size=20))+ 
  theme(legend.title = element_text(size=20, face="bold"))+
  theme(legend.position="none")
  

plt1m<-ggplot(y1m, aes(x=fac, y=acde.Estimate, color=fac)) + 
  ggtitle("Age at onset of menses") + 
  geom_point(position=position_dodge(), stat="identity",size=n0) +
  geom_errorbar(aes(ymin=acde.2.5., ymax=acde.97.5.),
                size=1,    
                width=.5,
                position=position_dodge(.9))+
  geom_hline(aes(yintercept = 0),  color = "grey")+
  scale_color_manual(values = c("#000000", "#999999", "#CCCCCC",  "#666666"))+
  theme_classic()+
  scale_x_discrete(name="Genetic component")+
  scale_y_continuous(name="Estimate")+
  theme(axis.title.x = element_text(size=20), axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text(size=20), axis.text.y  = element_text(size=20))+ 
  theme(legend.text = element_text(size=20))+ 
  theme(legend.title = element_text(size=20, face="bold"))+
  theme(legend.position="none")
  

plt2m<-ggplot(y2m, aes(x=fac, y=acde.Estimate, color=fac)) + 
  ggtitle("Correlation between IC12 and IC13") + 
  theme(plot.title = element_text(size = 20, face = "bold"))+
  geom_point(position=position_dodge(), stat="identity",size=n0) +
  geom_errorbar(aes(ymin=acde.2.5., ymax=acde.97.5.),
                size=1,    
                width=.5,
                position=position_dodge(.9))+
  geom_hline(aes(yintercept = 0),  color = "grey")+
  scale_color_manual(values = c("#000000", "#999999", "#CCCCCC",  "#666666"))+
  theme_classic()+
  scale_x_discrete(name="Genetic component")+
  scale_y_continuous(name="Estimate")+
  theme(axis.title.x = element_text(size=20), axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text(size=20), axis.text.y  = element_text(size=20))+ 
  theme(legend.text = element_text(size=20))+ 
  theme(legend.title = element_text(size=20, face="bold"))+
  theme(legend.position="none")

plt3m<-ggplot(y3m, aes(x=fac, y=acde.Estimate, color=fac)) + 
  ggtitle("Correlation between IC3 and IC6") + 
  theme(plot.title = element_text(size = 20, face = "bold"))+
  geom_point(position=position_dodge(), stat="identity",size=n0) +
  geom_errorbar(aes(ymin=acde.2.5., ymax=acde.97.5.),
                size=1,    
                width=.5,
                position=position_dodge(.9))+
  geom_hline(aes(yintercept = 0),  color = "grey")+
  scale_color_manual(values = c("#000000", "#999999", "#CCCCCC",  "#666666"))+
  theme_classic()+
  scale_x_discrete(name="Genetic component")+
  scale_y_continuous(name="Estimate")+
  theme(axis.title.x = element_text(size=20), axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text(size=20), axis.text.y  = element_text(size=20))+ 
  theme(legend.text = element_text(size=20))+ 
  theme(legend.title = element_text(size=20, face="bold"))+
  theme(legend.position="none")

plt4m<-ggplot(y4m, aes(x=fac, y=acde.Estimate, color=fac)) + 
  ggtitle("Correlation between motion and BMI") + 
  theme(plot.title = element_text(size = 20, face = "bold"))+
  geom_point(position=position_dodge(), stat="identity",size=n0) +
  geom_errorbar(aes(ymin=acde.2.5., ymax=acde.97.5.),
                size=1,    
                width=.5,
                position=position_dodge(.9))+
  geom_hline(aes(yintercept = 0),  color = "grey")+
  scale_color_manual(values = c("#000000", "#999999", "#CCCCCC",  "#666666"))+
  theme_classic()+
  scale_x_discrete(name="Genetic component")+
  scale_y_continuous(name="Estimate")+
  theme(axis.title.x = element_text(size=20), axis.text.x  = element_text(size=20))+
  theme(axis.title.y = element_text(size=20), axis.text.y  = element_text(size=20))+ 
  theme(legend.text = element_text(size=20))+ 
  theme(legend.title = element_text(size=20, face="bold"))+
  theme(legend.position="none")

acde<-ggarrange(plt0m,plt1m,plt2m,plt3m,plt4m + rremove("x.text"), 
          labels = c("A", "B","C","D"),
          ncol = 2, nrow = 3)
acde
```
```{r}
plt4m
```
```{r}
names(glm)<-c("Subject", "group","BMI_C","AOM_C","int","race","age")

write.table(cbind(d4m$Subject,d4m$group,d4m$BMI_C,d4m$AOM_C,d4m$int,d4m$race,d4m$age,d4m$motion), "~/Google Drive/HCP_graph/1200/datasets/subs510.csv", sep=",")
```





```{r}
node_df<-read.table("~/Google Drive/HCP_graph/1200/datasets/early_late_nodes.csv", header=TRUE, sep=",")
edge_df<-read.table("~/Google Drive/HCP_graph/1200/datasets/early_late_edges.csv", header = TRUE, sep=",")
head(node_df)
node_df$module<-as.factor(node_df$module)
names(node_df)
```

```{r}
node_int<-subset(node_df, node_df$group == 'int')
node_int6<-subset(node_df, node_df$IC == 'IC6')
node_int6$module<-as.factor(node_int6$module)
node_int3<-subset(node_df, node_df$IC == 'IC3')
node_int3$module<-as.factor(node_int3$module)
node_int12<-subset(node_df, node_df$IC == 'IC12')
node_int12$module<-as.factor(node_int12$module)
node_int13<-subset(node_df, node_df$IC == 'IC13')
node_int13$module<-as.factor(node_int13$module)
node_int2<-subset(node_df, node_df$IC == 'IC2')
node_int2$module<-as.factor(node_int2$module)
```


```{r}
levels(node_int6$module)
levels(node_int6$early_late)
freqin6 <- xtabs(~early_late+module, data=node_int6)
ftable(freqin6) # print table
summary(freqin6)

node_int6<-node_int6[!(node_int6$module=="7" | node_int6$module=="8" | node_int6$module=="9"),]
node_int6$module<-factor(node_int6$module)
levels(node_int6$module)

c0<-c(2,0,0,0,0,0,0)
c1<-c(0,2,0,0,0,0,0)
c2<-c(0,0,2,0,0,0,0)
c3<-c(0,0,0,2,0,0,0)
c4<-c(0,0,0,0,2,0,0)
c5<-c(0,0,0,0,0,2,0)
c6<-c(0,0,0,0,0,0,2)
c01<-c(1,-1,0,0,0,0,0)
c02<-c(1,0,-1,0,0,0,0)
c03<-c(1,0,0,-1,0,0,0)
c04<-c(1,0,0,0,-1,0,0)
c05<-c(1,0,0,0,0,-1,0)
c06<-c(1,0,0,0,0,0,-1)
c12<-c(0,1,-1,0,0,0,0)
c13<-c(0,1,0,-1,0,0,0)
c14<-c(0,1,0,0,-1,0,0)
c15<-c(0,1,0,0,0,-1,0)
c16<-c(0,1,0,0,0,0,-1)
c23<-c(0,0,1,-1,0,0,0)
c24<-c(0,0,1,0,-1,0,0)
c25<-c(0,0,1,0,0,-1,0)
c26<-c(0,0,1,0,0,0,-1)
c34<-c(0,0,0,1,-1,0,0)
c35<-c(0,0,0,1,0,-1,0)
c36<-c(0,0,0,1,0,0,-1)
c45<-c(0,0,0,0,1,-1,0)
c46<-c(0,0,0,0,1,0,-1)
c56<-c(0,0,0,0,0,1,-1)
contrasts(node_int6$module)<-cbind(c1,c2,c3,c4,c5,c6,c01,c02,c03,c04,c05,c06,c12,c13,c01,c14,c15,c16,c23,c24,c25,c26,c34,c35,c36,c45,c46,c56)
Contrasts<-list(cbind(c1,c2,c3,c4,c5,c6,c01,c02,c03,c04,c05,c06,c12,c13,c01,c14,c15,c16,c23,c24,c25,c26,c34,c35,c36,c45,c46,c56))
cel<-c(1,-1)
contrasts(node_int6$early_late)<-cbind(cel)
```

```{r}
modByel<-list(
c(1,0,0,0,0,0,0,-1,0,0,0,0,0,0),
c(0,1,0,0,0,0,0,0,-1,0,0,0,0,0),
c(0,0,1,0,0,0,0,0,0,-1,0,0,0,0),
c(0,0,0,1,0,0,0,0,0,0,-1,0,0,0),
c(0,0,0,0,1,0,0,0,0,0,0,-1,0,0),
c(0,0,0,0,0,1,0,0,0,0,0,0,-1,0),
c(0,0,0,0,0,0,1,0,0,0,0,0,0,-1))
```


```{r}
cc6<-lm(cc~module*early_late, data=node_int6)
means.mod <- lsmeans(cc6, specs = "module")
means.el  <- lsmeans(cc6, specs = "early_late")
means.int <- lsmeans(cc6, specs = c("module", "early_late"))
means.int
pairs(means.int, adjust = "bon")
```



```{r}
cc6<-lm(cc~module*early_late, data=node_int6)
summary(cc6)
interactionMeans(cc6)
testInteractions(cc6)
library(lsmeans)
leastsquare = lsmeans(cc6, "module")
means.int <- lsmeans(cc6, specs = c("module", "early_late"))
contrast(leastsquare, Contrasts, adjust="sidak")
contrast(means.wool, list(AvB = c(-1,1)))
```
# Summary 
There is an overall difference between early and late in clustering coefficient.
There is an overall difference between early and late in modules2, 
Between early and late puberty there is a difference in clustering coefficient between the 0 and 3 nodes.
```{r}
# Basic violin plot
cc6p <- ggplot(node_int6, aes(x=module, y=cc, color=module, fill=module)) + 
  geom_violin()+ facet_grid( . ~ early_late)+theme_classic()
cc6p
```

```{r}
btw6.1<-lme(btw~module*early_late, random = ~1|early_late/module, data=node_int6, method="ML")
summary(btw6.1)
interactionMeans(btw6.1)
testInteractions(btw6.1)


```

```{r}
# Basic violin plot
btw6p <- ggplot(node_int6, aes(x=module, y=btw, color=module, fill=module)) + 
  geom_violin()+ facet_grid( . ~ early_late)+theme_classic()
btw6p
```















